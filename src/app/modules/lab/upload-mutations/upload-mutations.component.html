<div class="min-h-screen bg-gray-50">
  <!-- Header -->
  <div class="bg-white shadow-sm border-b border-gray-200 px-6 py-4">
    <div class="max-w-6xl mx-auto">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-4">
          <button (click)="goBack()" 
                  class="w-8 h-8 rounded-lg bg-gray-100 hover:bg-gray-200 flex items-center justify-center transition-colors">
            <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
            </svg>
          </button>
          <div>
            <h1 class="text-2xl font-semibold text-gray-900">Crear Muestra de Mutaciones</h1>
            <p class="text-sm text-gray-600">Crea una nueva muestra y registra las mutaciones genéticas encontradas</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="loading" class="flex justify-center items-center py-16">
    <div class="animate-spin rounded-full h-8 w-8 border-2 border-blue-600 border-t-transparent"></div>
  </div>

  <!-- Main Content -->
  <div *ngIf="!loading" class="max-w-6xl mx-auto px-6 py-8">
    
    <!-- Sample Information Form -->
    <form [formGroup]="sampleForm" class="space-y-6">
      
      <!-- Basic Sample Information -->
      <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <h2 class="text-lg font-medium text-gray-900 mb-4">Información de la Muestra</h2>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <!-- Patient Search -->
          <div class="relative">
            <label class="block text-sm font-medium text-gray-700 mb-2">Buscar Paciente *</label>
            <div class="relative">
              <input 
                type="text" 
                formControlName="patientSearch"
                (focus)="onPatientSearchFocus()"
                (blur)="onPatientSearchBlur()"
                [class.border-red-300]="sampleForm.get('patientSearch')?.invalid && sampleForm.get('patientSearch')?.touched"
                class="w-full px-3 py-2 pr-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"
                placeholder="Buscar por nombre o número de identificación..."
                autocomplete="off">
              
              <!-- Clear button -->
              <button 
                *ngIf="selectedPatient" 
                type="button"
                (click)="clearPatientSelection()"
                class="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                </svg>
              </button>
              
              <!-- Loading indicator -->
              <div *ngIf="searchingPatients" class="absolute right-2 top-1/2 transform -translate-y-1/2">
                <div class="animate-spin rounded-full h-4 w-4 border-2 border-blue-600 border-t-transparent"></div>
              </div>
            </div>
            
            <!-- Dropdown with search results -->
            <div *ngIf="showPatientDropdown" 
                 class="absolute z-50 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto">
              <div *ngIf="filteredPatients.length === 0 && !searchingPatients" 
                   class="px-4 py-3 text-gray-500 text-sm">
                No se encontraron pacientes
              </div>
              <button 
                *ngFor="let patient of filteredPatients"
                type="button"
                (click)="selectPatient(patient)"
                class="w-full px-4 py-3 text-left hover:bg-gray-50 border-b border-gray-100 last:border-b-0 focus:outline-none focus:bg-gray-50">
                <div class="text-sm font-medium text-gray-900">{{ patient.firstName }} {{ patient.lastName }}</div>
                <div class="text-xs text-gray-500">Birth Date: {{ patient.birthDate }}</div>
              </button>
            </div>
            
            <!-- Selected patient display -->
            <div *ngIf="selectedPatient" class="mt-2 p-2 bg-green-50 border border-green-200 rounded text-sm">
              <div class="flex items-center text-green-800">
                <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                Paciente seleccionado: {{ getPatientLabel(selectedPatient) }}
              </div>
            </div>
            
            <div *ngIf="sampleForm.get('patientSearch')?.invalid && sampleForm.get('patientSearch')?.touched" 
                 class="text-red-600 text-sm mt-1">
              Busca y selecciona un paciente
            </div>
          </div>

          <!-- Collection Date -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Fecha de Recolección *</label>
            <input type="date" formControlName="collectionDate"
                   [class.border-red-300]="sampleForm.get('collectionDate')?.invalid && sampleForm.get('collectionDate')?.touched"
                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
            <div *ngIf="sampleForm.get('collectionDate')?.invalid && sampleForm.get('collectionDate')?.touched" 
                 class="text-red-600 text-sm mt-1">
              La fecha de recolección es requerida
            </div>
          </div>

          <!-- Notes -->
          <div class="md:col-span-2">
            <label class="block text-sm font-medium text-gray-700 mb-2">Notas</label>
            <textarea formControlName="notes" rows="3"
                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none resize-none"
                      placeholder="Observaciones adicionales sobre la muestra..."></textarea>
          </div>
        </div>
      </div>

      <!-- Mutations Analysis Data -->
      <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6" formGroupName="mutationsData">
        <h2 class="text-lg font-medium text-gray-900 mb-4">Datos del Análisis de Mutaciones</h2>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Número de Mutaciones *</label>
            <input type="number" formControlName="mutationCount" min="1"
                   [class.border-red-300]="sampleForm.get('mutationsData.mutationCount')?.invalid && sampleForm.get('mutationsData.mutationCount')?.touched"
                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"
                   placeholder="Ej. 10" readonly>
            <p class="text-xs text-gray-500 mt-1">Se actualiza automáticamente según las mutaciones cargadas</p>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Puntuación de Confianza (%) *</label>
            <input type="number" formControlName="analysisConfidenceScore" min="0" max="100" step="0.1"
                   [class.border-red-300]="sampleForm.get('mutationsData.analysisConfidenceScore')?.invalid && sampleForm.get('mutationsData.analysisConfidenceScore')?.touched"
                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"
                   placeholder="Ej. 95.5">
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Software de Procesamiento *</label>
            <input type="text" formControlName="processingSoftware"
                   [class.border-red-300]="sampleForm.get('mutationsData.processingSoftware')?.invalid && sampleForm.get('mutationsData.processingSoftware')?.touched"
                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"
                   placeholder="Ej. MutAnalyzer v2.1">
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Genoma de Referencia *</label>
            <select formControlName="referenceGenome"
                    [class.border-red-300]="sampleForm.get('mutationsData.referenceGenome')?.invalid && sampleForm.get('mutationsData.referenceGenome')?.touched"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
              <option value="GRCh38">GRCh38 (hg38)</option>
              <option value="GRCh37">GRCh37 (hg19)</option>
              <option value="T2T-CHM13">T2T-CHM13</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Mode Selection -->
      <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <h2 class="text-lg font-medium text-gray-900 mb-4">Método de Carga de Mutaciones</h2>
        <div class="flex space-x-4">
          <button type="button" (click)="uploadMode = 'manual'" 
                  [class]="uploadMode === 'manual' ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'"
                  class="px-6 py-3 rounded-lg font-medium transition-colors flex items-center space-x-2">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
              <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
            </svg>
            <span>Crear Tabla Manual</span>
          </button>
          
          <button type="button" (click)="uploadMode = 'file'" 
                  [class]="uploadMode === 'file' ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'"
                  class="px-6 py-3 rounded-lg font-medium transition-colors flex items-center space-x-2">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
              <path d="M9 16h6v-6h4l-7-7-7 7h4zm-4 2h14v2H5z"/>
            </svg>
            <span>Subir Archivo CSV</span>
          </button>
        </div>
      </div>

      <!-- Manual Mode -->
      <div *ngIf="uploadMode === 'manual'">
        <form [formGroup]="mutationsForm">
          <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-lg font-medium text-gray-900">Mutaciones Encontradas</h3>
              <button type="button" (click)="addMutation()" 
                      class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors flex items-center space-x-2">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                </svg>
                <span>Agregar Mutación</span>
              </button>
            </div>

            <div class="overflow-x-auto">
              <table class="w-full">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Gen</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cromosoma</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Relevancia</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Comentario</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                  </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                  <tr *ngFor="let mutation of mutationsArray.controls; let i = index" [formGroup]="$any(mutation)">
                    <td class="px-4 py-3">
                      <input type="text" formControlName="gene" placeholder="ej. BRCA1"
                             class="w-full px-2 py-1 border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500 outline-none text-sm">
                    </td>
                    <td class="px-4 py-3">
                      <select formControlName="chromosome" 
                              class="w-full px-2 py-1 border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500 outline-none text-sm">
                        <option value="">-</option>
                        <option *ngFor="let chr of chromosomes" [value]="chr">{{ chr }}</option>
                      </select>
                    </td>
                    <td class="px-4 py-3">
                      <select formControlName="type" 
                              class="w-full px-2 py-1 border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500 outline-none text-sm">
                        <option value="">-</option>
                        <option *ngFor="let type of mutationTypes" [value]="type">{{ type }}</option>
                      </select>
                    </td>
                    <td class="px-4 py-3">
                      <select formControlName="relevance" 
                              class="w-full px-2 py-1 border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500 outline-none text-sm">
                        <option value="">-</option>
                        <option *ngFor="let level of relevanceLevels" [value]="level">{{ level }}</option>
                      </select>
                    </td>
                    <td class="px-4 py-3">
                      <input type="text" formControlName="comment" placeholder="Descripción de la mutación"
                             class="w-full px-2 py-1 border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500 outline-none text-sm">
                    </td>
                    <td class="px-4 py-3">
                      <button type="button" (click)="removeMutation(i)" 
                              [disabled]="mutationsArray.length === 1"
                              class="text-red-600 hover:text-red-700 disabled:text-gray-400 disabled:cursor-not-allowed">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                          <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                        </svg>
                      </button>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>

            <div class="flex justify-end mt-6">
              <button type="button" (click)="createSampleWithManualMutations()" 
                      [disabled]="submitting || processing || !isFormValid()"
                      class="px-6 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-blue-300 text-white rounded-lg transition-colors flex items-center space-x-2">
                <div *ngIf="submitting || processing" class="animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent"></div>
                <span>{{ submitting ? 'Creando Muestra...' : processing ? 'Procesando...' : 'Crear Muestra y Registrar Mutaciones' }}</span>
              </button>
            </div>
          </div>
        </form>
      </div>

      <!-- File Upload Mode -->
      <div *ngIf="uploadMode === 'file'">
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
          <h3 class="text-lg font-medium text-gray-900 mb-4">Subir Archivo CSV</h3>
          
          <div class="space-y-4">
            <!-- Template Download -->
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
              <div class="flex items-start">
                <svg class="w-5 h-5 text-blue-600 mt-0.5 mr-3" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M13,9H11V7H13M13,17H11V11H13M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z"/>
                </svg>
                <div class="flex-1">
                  <h4 class="text-sm font-medium text-blue-900 mb-1">Formato del Archivo</h4>
                  <p class="text-sm text-blue-800 mb-3">
                    El archivo CSV debe tener las columnas: gene, chromosome, type, relevance, comment (separadas por tabs)
                  </p>
                  <button type="button" (click)="downloadTemplate()" 
                          class="px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white text-sm rounded transition-colors">
                    Descargar Plantilla
                  </button>
                </div>
              </div>
            </div>

            <!-- File Input -->
            <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-gray-400 transition-colors">
              <input type="file" (change)="onFileSelected($event)" accept=".csv" 
                     class="hidden" #fileInput>
              
              <div *ngIf="!selectedFile">
                <svg class="w-12 h-12 mx-auto text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 48 48">
                  <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <p class="text-sm text-gray-600 mb-2">
                  <button type="button" (click)="fileInput.click()" 
                          class="text-blue-600 hover:text-blue-700 font-medium">
                    Haz clic para seleccionar
                  </button> 
                  o arrastra un archivo CSV aquí
                </p>
                <p class="text-xs text-gray-500">Solo archivos CSV</p>
              </div>

              <div *ngIf="selectedFile" class="flex items-center justify-center space-x-3">
                <svg class="w-8 h-8 text-green-600" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                </svg>
                <div class="text-left">
                  <p class="text-sm font-medium text-gray-900">{{ selectedFile.name }}</p>
                  <p class="text-xs text-gray-500">{{ (selectedFile.size / 1024).toFixed(1) }} KB</p>
                </div>
                <button type="button" (click)="selectedFile = null; fileInput.value = ''" 
                        class="text-red-600 hover:text-red-700">
                  <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                  </svg>
                </button>
              </div>
            </div>

            <div class="flex justify-end">
              <button type="button" (click)="createSampleWithFile()" 
                      [disabled]="submitting || processing || !isFormValid()"
                      class="px-6 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-blue-300 text-white rounded-lg transition-colors flex items-center space-x-2">
                <div *ngIf="submitting || processing" class="animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent"></div>
                <span>{{ submitting ? 'Creando Muestra...' : processing ? 'Procesando...' : 'Crear Muestra y Procesar Archivo' }}</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </form>
  </div>
</div>