<div class="min-h-screen bg-slate-50 p-4 sm:p-6 lg:p-8">
  <div class="w-full max-w-5xl mx-auto">
    <!-- Header -->
    <div class="mb-8">
      <h2 class="text-2xl font-semibold text-slate-800 mb-2">Mis Estudios</h2>
      <p class="text-slate-600">Historial completo de análisis médicos</p>
    </div>

    <!-- Loading state -->
    <div *ngIf="loading" class="flex justify-center items-center py-16">
      <div class="flex items-center space-x-3 text-slate-600">
        <div class="animate-spin rounded-full h-5 w-5 border-2 border-slate-300 border-t-slate-600"></div>
        <span class="text-sm">Cargando estudios...</span>
      </div>
    </div>

    <!-- Empty state -->
    <div *ngIf="!loading && samples.length === 0" class="text-center py-16">
      <div class="w-16 h-16 mx-auto mb-4 bg-slate-100 rounded-full flex items-center justify-center">
        <svg class="w-8 h-8 text-slate-400" fill="currentColor" viewBox="0 0 24 24">
          <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
        </svg>
      </div>
      <p class="text-slate-600 font-medium">No tienes estudios registrados</p>
      <p class="text-slate-500 text-sm mt-1">Cuando tengas análisis disponibles aparecerán aquí</p>
    </div>

    <!-- Cards grid -->
    <div *ngIf="!loading && samples.length > 0" class="grid gap-4">
      <div *ngFor="let sample of samples" 
           class="bg-white rounded-lg border border-slate-200 p-6 hover:shadow-md transition-all duration-200">
        
        <!-- Header de la card -->
        <div class="flex items-start justify-between mb-4">
          <div class="flex items-start space-x-3">
            <!-- Icono del tipo de estudio -->
            <div class="w-10 h-10 rounded-lg flex items-center justify-center flex-shrink-0"
                 [ngClass]="getSampleTypeIcon(sample.type).bgColor">
              <svg class="w-5 h-5" [ngClass]="getSampleTypeIcon(sample.type).textColor" fill="currentColor" viewBox="0 0 24 24">
                <path [attr.d]="getSampleTypeIcon(sample.type).icon"/>
              </svg>
            </div>
            
            <div class="flex-1 min-w-0">
              <h3 class="text-lg font-semibold text-slate-800 mb-1">{{ getSampleTypeLabel(sample.type) }}</h3>
              <div class="flex items-center space-x-3 text-sm text-slate-500">
                <span>{{ sample.collectionDate | date:'dd/MM/yyyy' }}</span>
                <span class="w-1 h-1 bg-slate-300 rounded-full"></span>
                <span>Dr. {{ sample.registeredByName }}</span>
              </div>
            </div>
          </div>

          <!-- Status badge -->
          <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium"
                [ngClass]="getStatusStyle(sample.status)">
            {{ getStatusLabel(sample.status) }}
          </span>
        </div>

        <!-- Botones de acción -->
        <div class="flex items-center justify-between pt-4 border-t border-slate-100">
          <div class="flex items-center space-x-3">
            <!-- Botón reporte simplificado -->
            <button 
              *ngIf="hasPatientFriendlyReport(sample.id)"
              (click)="viewPatientReport(sample.id)"
              class="inline-flex items-center px-4 py-2 bg-emerald-50 text-emerald-700 rounded-lg hover:bg-emerald-100 transition-colors text-sm font-medium border border-emerald-200">
              <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
              </svg>
              Reporte Simplificado
            </button>

            <!-- Botón reporte médico -->
            <button 
              *ngIf="hasMedicalReport(sample.id)"
              (click)="viewMedicalReport(sample.id)"
              class="inline-flex items-center px-4 py-2 bg-blue-50 text-blue-700 rounded-lg hover:bg-blue-100 transition-colors text-sm font-medium border border-blue-200">
              <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14-7H3a2 2 0 00-2 2v12a2 2 0 002 2h16a2 2 0 002-2V6a2 2 0 00-2-2z"/>
              </svg>
              Reporte Técnico
            </button>
          </div>

          <!-- Indicador cuando no hay reportes -->
          <div *ngIf="!hasPatientFriendlyReport(sample.id) && !hasMedicalReport(sample.id)" 
               class="flex items-center text-amber-600 text-sm">
            <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 24 24">
              <path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,17A1.5,1.5 0 0,1 10.5,15.5A1.5,1.5 0 0,1 12,14A1.5,1.5 0 0,1 13.5,15.5A1.5,1.5 0 0,1 12,17M12,10.5A1.5,1.5 0 0,1 10.5,9A1.5,1.5 0 0,1 12,7.5A1.5,1.5 0 0,1 13.5,9A1.5,1.5 0 0,1 12,10.5Z"/>
            </svg>
            Análisis en progreso
          </div>

          <!-- Botón ver detalles -->
          <button 
            (click)="showDetails(sample)"
            class="inline-flex items-center px-3 py-2 text-slate-600 hover:text-slate-800 transition-colors text-sm font-medium">
            Ver detalles
            <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
            </svg>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal mejorado -->
<div *ngIf="selectedSample" class="fixed inset-0 z-50 overflow-y-auto">
  <div class="fixed inset-0 bg-black/50 transition-opacity" (click)="closeModal()"></div>
  
  <div class="flex min-h-full items-center justify-center p-4">
    <div class="relative bg-white rounded-xl shadow-xl max-w-2xl w-full max-h-[85vh] overflow-hidden">
      
      <!-- Header del modal -->
      <div class="bg-slate-50 border-b border-slate-200 px-6 py-4 flex items-center justify-between">
        <div>
          <h3 class="text-xl font-semibold text-slate-800">{{ getSampleTypeLabel(selectedSample.type) }}</h3>
          <p class="text-sm text-slate-600 mt-1">{{ selectedSample.collectionDate | date:'fullDate' }}</p>
        </div>
        <button (click)="closeModal()" 
                class="w-8 h-8 rounded-lg bg-white hover:bg-slate-100 flex items-center justify-center transition-colors border border-slate-200">
          <svg class="w-4 h-4 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>

      <!-- Contenido del modal -->
      <div class="overflow-y-auto max-h-[70vh] p-6">
        <!-- Información básica -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Registrado por</label>
            <p class="text-slate-900">Dr. {{ selectedSample.registeredByName }}</p>
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Estado</label>
            <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium"
                  [ngClass]="getStatusStyle(selectedSample.status)">
              {{ getStatusLabel(selectedSample.status) }}
            </span>
          </div>
          <div class="md:col-span-2" *ngIf="selectedSample.notes">
            <label class="block text-sm font-medium text-slate-700 mb-1">Notas</label>
            <p class="text-slate-900">{{ selectedSample.notes }}</p>
          </div>
        </div>

        <!-- Datos específicos del análisis de sangre (parseado y organizado) -->
        <div *ngIf="selectedSample.bloodData" class="border-t border-slate-200 pt-6">
          <h4 class="text-lg font-semibold text-slate-800 mb-6">Resultados del Análisis de Sangre</h4>
          
          <!-- Metadatos del laboratorio si existen -->
          <div *ngIf="selectedSample.bloodData.analyzerModel || selectedSample.bloodData.centrifugationSpeedRpm" 
               class="mb-6 p-4 bg-slate-50 rounded-lg border border-slate-200">
            <h5 class="font-medium text-slate-700 mb-3">Información del Laboratorio</h5>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
              <div *ngIf="selectedSample.bloodData.analyzerModel">
                <span class="text-slate-500">Equipo:</span>
                <span class="ml-2 font-medium text-slate-700">{{ selectedSample.bloodData.analyzerModel }}</span>
              </div>
              <div *ngIf="selectedSample.bloodData.centrifugationSpeedRpm">
                <span class="text-slate-500">Centrifugación:</span>
                <span class="ml-2 font-medium text-slate-700">{{ selectedSample.bloodData.centrifugationSpeedRpm }} RPM</span>
              </div>
              <div *ngIf="selectedSample.bloodData.storageTemperatureCelsius">
                <span class="text-slate-500">Temperatura de almacenamiento:</span>
                <span class="ml-2 font-medium text-slate-700">{{ selectedSample.bloodData.storageTemperatureCelsius }}°C</span>
              </div>
            </div>
          </div>

          <!-- Secciones organizadas de resultados -->
          <div class="space-y-6">
            <div *ngFor="let section of getBloodDataSections(selectedSample.bloodData)" 
                 class="border rounded-lg overflow-hidden" [ngClass]="section.borderColor">
              
              <!-- Header de la sección -->
              <div class="px-4 py-3 flex items-center" [ngClass]="section.bgColor">
                <div class="w-8 h-8 rounded-lg bg-white flex items-center justify-center mr-3 border" [ngClass]="section.borderColor">
                  <svg class="w-4 h-4" [ngClass]="section.textColor" fill="currentColor" viewBox="0 0 24 24">
                    <path [attr.d]="section.icon"/>
                  </svg>
                </div>
                <h5 class="font-semibold" [ngClass]="section.textColor">{{ section.title }}</h5>
              </div>

              <!-- Campos de la sección -->
              <div class="p-4 bg-white">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div *ngFor="let field of section.fields" 
                       class="flex items-center justify-between p-3 rounded-lg border transition-colors hover:bg-slate-50">
                    
                    <div class="flex-1">
                      <div class="flex items-center justify-between mb-1">
                        <label class="text-sm font-medium text-slate-700">{{ field.label }}</label>
                        <div class="flex items-center">
                          <!-- Indicador de estado -->
                          <div class="w-4 h-4 mr-2 rounded-full border flex items-center justify-center"
                               [ngClass]="getValueStatusStyle(isValueNormal(field.value, field.normalRange))">
                            <svg class="w-2.5 h-2.5" fill="currentColor" viewBox="0 0 24 24">
                              <path [attr.d]="getValueStatusIcon(isValueNormal(field.value, field.normalRange))"/>
                            </svg>
                          </div>
                        </div>
                      </div>
                      
                      <div class="flex items-baseline justify-between">
                        <span class="text-lg font-semibold text-slate-900">
                          {{ field.value }}
                          <span class="text-sm font-normal text-slate-500 ml-1">{{ field.unit }}</span>
                        </span>
                      </div>
                      
                      <div class="text-xs text-slate-500 mt-1">
                        Rango normal: {{ field.normalRange }}
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div *ngIf="selectedSample.dnaData" class="border-t border-slate-200 pt-6">
          <h4 class="text-lg font-semibold text-slate-800 mb-4">Resultados del Análisis</h4>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div *ngFor="let item of (selectedSample.dnaData | keyvalue)" class="bg-slate-50 rounded-lg p-3">
              <label class="block text-xs font-medium text-slate-600 mb-1">{{ item.key }}</label>
              <p class="text-slate-900 font-medium">{{ item.value }}</p>
            </div>
          </div>
        </div>

        <div *ngIf="selectedSample.salivaData" class="border-t border-slate-200 pt-6">
          <h4 class="text-lg font-semibold text-slate-800 mb-4">Resultados del Análisis</h4>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div *ngFor="let item of (selectedSample.salivaData | keyvalue)" class="bg-slate-50 rounded-lg p-3">
              <label class="block text-xs font-medium text-slate-600 mb-1">{{ item.key }}</label>
              <p class="text-slate-900 font-medium">{{ item.value }}</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>